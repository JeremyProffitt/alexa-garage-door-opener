name: Deploy Garage Door Opener

on:
  push:
    branches:
      - main
      - claude/**
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-test:
    name: Build and Test Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download Go dependencies (Alexa Skill)
        working-directory: lambda/alexa-skill
        run: |
          go mod download
          go mod verify

      - name: Download Go dependencies (Monitor)
        working-directory: lambda/monitor
        run: |
          go mod download
          go mod verify

      - name: Run Go tests (Alexa Skill)
        working-directory: lambda/alexa-skill
        run: go test -v ./...

      - name: Run Go tests (Monitor)
        working-directory: lambda/monitor
        run: go test -v ./... || true

      - name: Build Alexa Skill Lambda
        working-directory: lambda/alexa-skill
        run: make build

      - name: Build Monitor Lambda
        working-directory: lambda/monitor
        run: make build

      - name: Upload Alexa Skill Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: alexa-skill-lambda
          path: lambda/alexa-skill/bootstrap
          retention-days: 1

      - name: Upload Monitor Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: monitor-lambda
          path: lambda/monitor/bootstrap
          retention-days: 1

  deploy-lambda:
    name: Deploy Lambda with SAM
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/claude/')

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_CLIENT_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Alexa Skill Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: alexa-skill-lambda
          path: lambda/alexa-skill/

      - name: Download Monitor Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: monitor-lambda
          path: lambda/monitor/

      - name: Make bootstrap files executable
        run: |
          chmod +x lambda/alexa-skill/bootstrap
          chmod +x lambda/monitor/bootstrap

      - name: Setup Particle credentials in SSM
        env:
          PARTICLE_TOKEN: ${{ secrets.PARTICLE_ACCESS_TOKEN }}
          PARTICLE_DEVICE: ${{ secrets.PARTICLE_DEVICE_ID }}
        run: |
          # Always create parameters (use placeholder if not configured)
          TOKEN_VALUE="${PARTICLE_TOKEN:-NOTCONFIGURED}"
          DEVICE_VALUE="${PARTICLE_DEVICE:-NOTCONFIGURED}"

          aws ssm put-parameter \
            --name "/garage-door/particle-token" \
            --value "$TOKEN_VALUE" \
            --type "SecureString" \
            --overwrite || true

          aws ssm put-parameter \
            --name "/garage-door/device-id" \
            --value "$DEVICE_VALUE" \
            --type "String" \
            --overwrite || true

          if [ "$TOKEN_VALUE" = "NOTCONFIGURED" ]; then
            echo "⚠️ Particle access token not configured - using placeholder"
          else
            echo "✓ Particle access token configured"
          fi

          if [ "$DEVICE_VALUE" = "NOTCONFIGURED" ]; then
            echo "⚠️ Particle device ID not configured - using placeholder"
          else
            echo "✓ Particle device ID configured"
          fi

      - name: SAM Build
        working-directory: lambda
        run: sam build --use-container

      - name: SAM Deploy
        working-directory: lambda
        run: |
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name garage-door-opener \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --parameter-overrides "AlexaSkillId=${{ vars.ALEXA_SKILL_ID || '' }} NotificationEmail=${{ vars.NOTIFICATION_EMAIL || '' }} DoorOpenThresholdMinutes=${{ vars.DOOR_OPEN_THRESHOLD_MINUTES || '120' }}"

      - name: Get Lambda ARN
        id: lambda-arn
        run: |
          ARN=$(aws cloudformation describe-stacks \
            --stack-name garage-door-opener \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AlexaSkillFunctionArn`].OutputValue' \
            --output text)
          echo "arn=$ARN" >> $GITHUB_OUTPUT
          echo "Lambda Function ARN: $ARN"

      - name: Output deployment info
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lambda Functions" >> $GITHUB_STEP_SUMMARY
          echo "- **Alexa Skill Lambda ARN**: ${{ steps.lambda-arn.outputs.arn }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Monitor Lambda**: Runs every 15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack**: garage-door-opener" >> $GITHUB_STEP_SUMMARY
          echo "- **DynamoDB Table**: garage-door-opener-door-state" >> $GITHUB_STEP_SUMMARY
          echo "- **SNS Topic**: garage-door-opener-notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features" >> $GITHUB_STEP_SUMMARY
          echo "- Door status tracking in DynamoDB" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic notifications if door open > ${{ vars.DOOR_OPEN_THRESHOLD_MINUTES || '120' }} minutes" >> $GITHUB_STEP_SUMMARY
          echo "- EventBridge scheduled monitoring every 15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure your Alexa skill endpoint with the Lambda ARN above" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`./scripts/setup-alexa-skill.sh\` for automated Alexa skill setup" >> $GITHUB_STEP_SUMMARY
          echo "3. If NotificationEmail was set, confirm SNS subscription in your email" >> $GITHUB_STEP_SUMMARY

  deploy-firmware:
    name: Deploy Particle Firmware
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/claude/')
    continue-on-error: true  # Don't fail if device is offline

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Particle CLI
        run: npm install -g particle-cli

      - name: Login to Particle
        env:
          PARTICLE_TOKEN: ${{ secrets.PARTICLE_ACCESS_TOKEN }}
        run: |
          if [ -z "$PARTICLE_TOKEN" ]; then
            echo "Particle access token not configured, skipping firmware deployment"
            exit 0
          fi
          echo "$PARTICLE_TOKEN" | particle login --token

      - name: Compile firmware
        env:
          PARTICLE_TOKEN: ${{ secrets.PARTICLE_ACCESS_TOKEN }}
        working-directory: firmware
        run: |
          if [ -z "$PARTICLE_TOKEN" ]; then
            echo "Skipping firmware compilation (Particle token not configured)"
            exit 0
          fi
          particle compile argon src/ --saveTo firmware.bin

      - name: Flash firmware to device
        env:
          PARTICLE_TOKEN: ${{ secrets.PARTICLE_ACCESS_TOKEN }}
        continue-on-error: true
        run: |
          if [ -z "$PARTICLE_TOKEN" ]; then
            echo "Skipping firmware flash (Particle token not configured)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          set +e
          particle flash garage-door-opener firmware/firmware.bin
          FLASH_RESULT=$?

          if [ $FLASH_RESULT -eq 0 ]; then
            echo " Firmware flashed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "� Firmware flash failed (device may be offline)" >> $GITHUB_STEP_SUMMARY
            echo "Firmware binary saved as artifact for manual flashing" >> $GITHUB_STEP_SUMMARY
          fi

          exit 0

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: particle-firmware
          path: firmware/firmware.bin
          retention-days: 7

      - name: Firmware deployment summary
        if: always()
        run: |
          echo "## Firmware Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Device**: garage-door-opener" >> $GITHUB_STEP_SUMMARY
          echo "- **Firmware**: Available as artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To manually flash firmware:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "particle flash garage-door-opener firmware.bin" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
